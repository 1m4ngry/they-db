#!/bin/sh -e

[ "$1" = configure ] || exit 0

oldcatdir=/var/catman
catdir=/var/cache/man
maybesetuid='man mandb'

# For now we depend on debconf. If this causes problems with base system
# interdependencies I'm willing to consider making it optional.

. /usr/share/debconf/confmodule
db_version 2.0
db_get man-db/install-setuid

# Sorry about this, but #98224 is right - statoverrides don't work as
# cleanly as I'd hoped here. I'm going to have to carry around some cruft
# for a while.
for x in $maybesetuid; do
    if dpkg --compare-versions "$2" eq 2.3.18-4 && \
	    [ "`dpkg-statoverride --list /usr/lib/man-db/$x`" = \
	      "man root 4755 /usr/lib/man-db/$x" ]; then
	dpkg-statoverride --remove /usr/lib/man-db/$x
    fi
done

if [ "$RET" = true ]; then
    # man and mandb are to be installed setuid man, and for now we need the
    # wrapper.
    owner=man:root
    mode=4755
    wrapper=1
else
    # man and mandb are not to be installed setuid, and we install symlinks
    # directly to the executables.
    owner=root:root
    mode=0755
    wrapper=0
fi

for x in $maybesetuid; do
    if [ $wrapper -eq 1 ]; then target=wrapper; else target=$x; fi
    # No statoverrides available or none exist for us ...
    if [ ! -x /usr/sbin/dpkg-statoverride ] || \
	    ! dpkg-statoverride --list /usr/lib/man-db/$x >/dev/null; then
	chown $owner /usr/lib/man-db/$x
	chmod $mode  /usr/lib/man-db/$x
	ln -sf ../lib/man-db/$target /usr/bin/$x
    fi
    # Make sure we end up with a symlink
    [ -L /usr/bin/$x ] || ln -sf ../lib/man-db/$target /usr/bin/$x
done

if [ -e /etc/cron.daily/man.moved-by-preinst ]; then
    rm /etc/cron.daily/man.moved-by-preinst
fi
if [ -e /etc/cron.weekly/catman.moved-by-preinst ]; then
    rm /etc/cron.weekly/catman.moved-by-preinst
fi

if dpkg --compare-versions "$2" lt 2.3.18; then
    # /usr/local/man now mapped to /var/cache/man/oldlocal
    if [ -d $catdir/local -a ! -d $catdir/oldlocal ]; then
	mv -f $catdir/local $catdir/oldlocal
    fi
fi

# Old packages removed catpages on upgrade. The preinst hack should have
# avoided this, but let's be sure.
if [ ! -d $catdir ]; then
    install -d -g root -m 02755 -o man $catdir
fi

build_db=0

if [ ! -f $catdir/index.bt ]; then
    if dpkg --compare-versions "$2" lt 2.3.16; then
	db_get man-db/build-database
	if [ "$RET" = true ]; then
	    build_db=1
	fi
    else
	# Um. At this point all bets are off. The config script won't have
	# asked the question, so we can't db_get it ... but the database
	# should never be missing when upgrading from >= 2.3.16. In this
	# case, bad luck, the database gets built.
	build_db=1
    fi
elif dpkg --compare-versions "$2" lt 2.3.17.1-5; then
    db_get man-db/rebuild-database
    if [ "$RET" = true ]; then
	build_db=1
    fi
fi

if [ "$build_db" -eq 1 ]; then
    nice su man -c 'mandb -c 2>/dev/null >/dev/null' &
fi

#DEBHELPER#

db_stop

exit 0
